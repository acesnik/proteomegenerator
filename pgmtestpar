
localrules: mqpar_conversion, mqpar_user

rule mqpar_conversion:
    input: "180301_SwissProt_isoforms_cRAP.fasta", par = PAR, raw = RAW, temp = TMP
    output: RAW + "/mqpar.xml"
    benchmark: "out/benchmarks/merged.mqpar_conversion.txt"
    log: "out/logs/merged.mqpar_conversion.txt"
    params: t="68",n="1", R="'span[hosts=1] rusage[mem=10]'", J="mqpar_conversion", o="out/logs/mqpar_conversion.out", eo="out/logs/mqpar_conversion.err"
    run:
        import os
        raw_files = []
        for file in os.listdir(input.raw):
            if file.endswith(".raw"):
                raw_files.append(os.path.join(input.raw, file))

        with open(input.par) as oldMQPar, open(output[0],"w") as newMQPar:
            for line in oldMQPar:
                if '<fastaFilePath>' not in line and '<tempFolder>' not in line and '<fixedCombinedFolder>' not in line:
                    newMQPar.write(line)
                if '<FastaFileInfo>' in line:
                    newMQPar.write("<fastaFilePath>" + os.getcwd() + "/"+ input[0] + "</fastaFilePath>\n")
                if '<maxQuantVersion>' in line:
                    newMQPar.write("<tempFolder>" + "</tempFolder>\n")
                if '<emailFromAddress>' in line:
                    newMQPar.write("<fixedCombinedFolder>" + os.getcwd() + "/output/" + "</fixedCombinedFolder>\n")
                if '<pluginFolder></pluginFolder>' in line:
                    newMQPar.write("<numThreads>"+params.t+"</numThreads>\n")
                if '<filePaths>' in line:
                    for k in range(len(raw_files)):
                        newMQPar.write("<string>" + raw_files[k] + "</string>\n")
                if '<experiments>' in line:
                    for k in range(len(raw_files)):
                        newMQPar.write("<string></string>\n")
                if '<fractions>' in line:
                    for k in range(len(raw_files)):
                        newMQPar.write("<short>32767</short>\n")
                if '<ptms>' in line:
                    for k in range(len(raw_files)):
                        newMQPar.write("<boolean>False</boolean>\n")
                if '<paramGroupIndices>' in line:
                    for k in range(len(raw_files)):
                        newMQPar.write("<int>0</int>\n")


rule mqpar_user:
    input: "proteome.unique.fasta", par = PAR , raw = RAW, temp = TMP
    output: RAW + "/mqpar.xml"
    benchmark: "out/benchmarks/merged.mqpar_conversion.txt"
    log: "out/logs/merged.mqpar_conversion.txt"
    params: t="68",n="1", R="'span[hosts=1] rusage[mem=10]'", J="mqpar_conversion", o="out/logs/mqpar_conversion.out", eo="out/logs/mqpar_conversion.err"
    run:
        import os
        raw_files = []
        for file in os.listdir(input.raw):
            if file.endswith(".raw"):
                raw_files.append(os.path.join(input.raw, file))

        with open(input.par) as oldMQPar, open(output[0],"w") as newMQPar:
            for line in oldMQPar:
                if '<fastaFilePath>' not in line and '<tempFolder>' not in line and '<fixedCombinedFolder>' not in line:
                    newMQPar.write(line)
                if '<FastaFileInfo>' in line:
                    newMQPar.write("<fastaFilePath>" + os.getcwd() + "/"+ input[0] + "</fastaFilePath>\n")
                if '<maxQuantVersion>' in line:
                    newMQPar.write("<tempFolder>" + input.temp + "</tempFolder>\n")
                if '<emailFromAddress>' in line:
                    newMQPar.write("<fixedCombinedFolder>" + os.getcwd() + "/out/" + "</fixedCombinedFolder>\n")



rule maxQuant:
    input: par = RAW + "/mqpar.xml", mq = MQ
    output: RAW + "/combined/txt/summary.txt"
    benchmark: "out/benchmarks/maxQuant.txt"
    log: "out/logs/merged.maxQuant.txt"
    singularity: "docker://mono:5.12.0.226"
    params: n="5", J="MQ", R="'span[ptile=68] rusage[mem=10]'", o="out/logs/mq.out", eo="out/logs/mq.err"
    shell: "mono {input.mq} {input.par}"

